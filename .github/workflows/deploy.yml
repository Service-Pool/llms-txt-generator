name: Deploy

on:
  workflow_dispatch:
    inputs:
      app:
        description: "Application to deploy"
        required: true
        type: choice
        options:
          - both
          - ui
          - api
        default: "both"
  # push:
  #   branches: [main]

jobs:
  clone:
    uses: Service-Pool/scripts/.github/workflows/reusable-deploy.yml@main
    with:
      repo_url: git@github.com:${{ github.repository }}.git
      destination: /var/www/llms-txt
      branch: ${{ github.ref_name }}
    secrets: inherit

  deploy-ui:
    needs: clone
    if: ${{ github.event.inputs.app == 'ui' || github.event.inputs.app == 'both' }}
    runs-on: [self-hosted, ubuntu-4gb-hel1-1]
    steps:
      - name: Deploy UI
        run: |
          set -euo pipefail
          echo "Deploying UI..."
          cd /var/www/llms-txt/apps/ui/.devcontainer/mapped
          docker compose down
          docker compose up --build -d --wait
          bash cmd-run.sh

  deploy-api:
    needs: clone
    if: ${{ github.event.inputs.app == 'api' || github.event.inputs.app == 'both' }}
    runs-on: [self-hosted, ubuntu-4gb-hel1-1]
    steps:
      - name: Deploy API
        run: |
          set -euo pipefail
          echo "Deploying API..."
          cd /var/www/llms-txt/apps/api/.devcontainer/mapped
          docker compose down
          docker compose up --build -d --wait
          bash cmd-run.sh
